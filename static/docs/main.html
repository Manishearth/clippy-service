<!DOCTYPE html>

<html>
<head>
  <title>main.rs</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>main.rs</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Run as an application, this is the starting point for our app</p>

            </div>
            
            <div class="content"><div class='highlight'><pre> <span class="hljs-meta">#![feature(slice_concat_ext)]</span>

<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> iron;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> staticfile;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> redis;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> rustc_serialize;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> hyper;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> url;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> time;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> tempdir;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> zip;

<span class="hljs-meta">#[macro_use]</span>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> router;

<span class="hljs-meta">#[macro_use]</span>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> mime;

<span class="hljs-comment">// for logging</span>
<span class="hljs-meta">#[macro_use]</span>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> log;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> env_logger;

<span class="hljs-keyword">use</span> std::fs::File;
<span class="hljs-keyword">use</span> std::path::Path;
<span class="hljs-keyword">use</span> std::io::{Read, Cursor, Write};
<span class="hljs-keyword">use</span> std::fs;
<span class="hljs-keyword">use</span> std::<span class="hljs-keyword">u8</span>;
<span class="hljs-keyword">use</span> std::vec::<span class="hljs-built_in">Vec</span>;
<span class="hljs-keyword">use</span> std::env;
<span class="hljs-keyword">use</span> std::thread;
<span class="hljs-keyword">use</span> std::process::Command;
<span class="hljs-keyword">use</span> tempdir::TempDir;
<span class="hljs-keyword">use</span> time::now_utc;
<span class="hljs-keyword">use</span> zip::*;

<span class="hljs-keyword">use</span> rustc_serialize::json::Json;

<span class="hljs-keyword">use</span> iron::modifiers::Redirect;
<span class="hljs-keyword">use</span> iron::prelude::*;
<span class="hljs-keyword">use</span> iron::status;
<span class="hljs-keyword">use</span> iron::Url <span class="hljs-keyword">as</span> iUrl;

<span class="hljs-keyword">use</span> url::Url;

<span class="hljs-keyword">use</span> hyper::client::{Client, RedirectPolicy};
<span class="hljs-keyword">use</span> hyper::header::{Headers, Accept, qitem};
<span class="hljs-keyword">use</span> hyper::mime::{Mime, TopLevel, SubLevel};
<span class="hljs-keyword">use</span> hyper::header;

<span class="hljs-keyword">use</span> staticfile::Static;
<span class="hljs-keyword">use</span> router::Router;

<span class="hljs-keyword">use</span> std::slice::<span class="hljs-built_in">SliceConcatExt</span>;
<span class="hljs-keyword">use</span> redis::{Commands, PipelineCommands, Value};

<span class="hljs-keyword">pub</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">ClippyState</span></span> {
    Running,
    EndedFine,
    EndedWithWarnings,
    EndedWithErrors
}

<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ClippyResult</span></span> {
    state: ClippyState,
    warnings: <span class="hljs-keyword">u8</span>,
    errors: <span class="hljs-keyword">u8</span>,
}

<span class="hljs-keyword">static</span> LINTING_BADGE_URL: &amp;<span class="hljs-symbol">'static</span> <span class="hljs-keyword">str</span> = <span class="hljs-string">"https://img.shields.io/badge/clippy-linting-blue"</span>;

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">download_and_unzip</span></span>(source_url: &amp;<span class="hljs-keyword">str</span>, tmp_dir: &amp;TempDir) -&gt; <span class="hljs-built_in">Result</span>&lt;<span class="hljs-built_in">Vec</span>&lt;<span class="hljs-built_in">String</span>&gt;, <span class="hljs-built_in">String</span>&gt; {

    <span class="hljs-keyword">let</span> client = Client::new();
    <span class="hljs-keyword">let</span> res = client.get(&amp;source_url.to_owned())
                    .header(header::UserAgent(<span class="hljs-string">"Clippy/0.1"</span>.to_owned()))
                    .header(header::Accept(<span class="hljs-built_in">vec!</span>[qitem(mime!(_/_))]))
                    .header(header::Connection::close());

    <span class="hljs-keyword">match</span> res.send() {
        <span class="hljs-literal">Ok</span>(<span class="hljs-keyword">mut</span> res) =&gt; {
            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> zip_body: <span class="hljs-built_in">Vec</span>&lt;<span class="hljs-keyword">u8</span>&gt; = <span class="hljs-built_in">Vec</span>::new();
            <span class="hljs-keyword">match</span> res.read_to_end(&amp;<span class="hljs-keyword">mut</span> zip_body) {
                <span class="hljs-literal">Ok</span>(_) =&gt; {
                    <span class="hljs-keyword">match</span> zip::ZipArchive::new(Cursor::new(zip_body)) {
                        <span class="hljs-literal">Ok</span>(<span class="hljs-keyword">mut</span> archive) =&gt; {
                            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> paths: <span class="hljs-built_in">Vec</span>&lt;<span class="hljs-built_in">String</span>&gt; = <span class="hljs-built_in">Vec</span>::new();
                            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..archive.len() {
                                <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> zip_file = archive.by_index(i).unwrap();
                                <span class="hljs-keyword">let</span> extracted_path = tmp_dir.path().join(zip_file.name());
                                <span class="hljs-keyword">let</span> full_path = extracted_path.as_path();

                                <span class="hljs-keyword">if</span> zip_file.size() == <span class="hljs-number">0</span> {
                                    fs::create_dir_all(full_path);
                                } <span class="hljs-keyword">else</span> {
                                    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> writer = File::create(full_path).unwrap();
                                    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> buffer: <span class="hljs-built_in">Vec</span>&lt;<span class="hljs-keyword">u8</span>&gt; = <span class="hljs-built_in">vec!</span>[];
                                    zip_file.read_to_end(&amp;<span class="hljs-keyword">mut</span> buffer).unwrap();
                                    writer.write(&amp;buffer).unwrap();
                                    paths.push(<span class="hljs-built_in">String</span>::from(full_path.to_string_lossy().into_owned()));
                                }
                            }
                            <span class="hljs-literal">Ok</span>(paths)
                        },
                        <span class="hljs-literal">Err</span>(zip::result::ZipError::InvalidArchive(error)) | <span class="hljs-literal">Err</span>(zip::result::ZipError::UnsupportedArchive(error)) =&gt; <span class="hljs-literal">Err</span>(<span class="hljs-built_in">format!</span>(<span class="hljs-string">"Extracting archive failed: {}"</span>, error).to_owned()),
                        <span class="hljs-literal">Err</span>(zip::result::ZipError::FileNotFound) =&gt; <span class="hljs-literal">Err</span>(<span class="hljs-built_in">String</span>::from(<span class="hljs-string">"Zip  Archive Corrupt"</span>)),
                        <span class="hljs-literal">Err</span>(_) =&gt; <span class="hljs-literal">Err</span>(<span class="hljs-built_in">String</span>::from(<span class="hljs-string">"General IO Error"</span>))
                    }
                },
                <span class="hljs-literal">Err</span>(error) =&gt; <span class="hljs-literal">Err</span>(<span class="hljs-built_in">format!</span>(<span class="hljs-string">"Couldn't read github response: {}"</span>, error))
            }
        },
        <span class="hljs-literal">Err</span>(error) =&gt; <span class="hljs-literal">Err</span>(<span class="hljs-built_in">format!</span>(<span class="hljs-string">"Couldn't connect to github: {}"</span>, error))
    }
}


<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">run_clippy</span></span>&lt;F&gt;(path: &amp;Path, logger: F) -&gt; <span class="hljs-built_in">Result</span>&lt;ClippyResult, <span class="hljs-built_in">String</span>&gt;
    <span class="hljs-keyword">where</span> F : <span class="hljs-built_in">Fn</span>(&amp;<span class="hljs-keyword">str</span>) {
    <span class="hljs-keyword">match</span> Command::new(<span class="hljs-string">"cargo"</span>)
                .args(&amp;[<span class="hljs-string">"rustc"</span>, <span class="hljs-string">"--"</span>, <span class="hljs-string">"-Zunstable-options"</span>,
                        <span class="hljs-string">"-Zextra-plugins=clippy"</span>, <span class="hljs-string">"-Zno-trans"</span>,
                        <span class="hljs-string">"-lclippy"</span>, <span class="hljs-string">"--error-format=json"</span>])
                  .current_dir(path)
                  .output() {
        <span class="hljs-literal">Ok</span>(output) =&gt; {
            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> warnings = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> errors = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">let</span> messages: <span class="hljs-built_in">Vec</span>&lt;<span class="hljs-built_in">String</span>&gt; = <span class="hljs-built_in">String</span>::from_utf8(output.stderr)
                                  .unwrap_or(<span class="hljs-built_in">String</span>::from(<span class="hljs-string">""</span>))
                                  .split(<span class="hljs-string">"\n"</span>)
                                  .filter_map(|line| Json::from_str(&amp;line).ok())
                                  .filter_map(|json| {
                                      <span class="hljs-keyword">let</span> obj = json.as_object().unwrap();
                                      <span class="hljs-keyword">match</span> obj.get(<span class="hljs-string">"level"</span>) {
                                          <span class="hljs-literal">Some</span>(&amp;Json::<span class="hljs-built_in">String</span>(<span class="hljs-keyword">ref</span> level)) =&gt; {
                                              <span class="hljs-keyword">if</span> level == <span class="hljs-string">"warning"</span> {
                                                 warnings += <span class="hljs-number">1</span>;
                                              } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> level == <span class="hljs-string">"error"</span> {
                                                  errors += <span class="hljs-number">1</span>;
                                              }
                                              <span class="hljs-literal">Some</span>(<span class="hljs-built_in">format!</span>(<span class="hljs-string">"{level}: {msg}"</span>, level=level, msg=obj.get(<span class="hljs-string">"message"</span>).unwrap()))
                                          },
                                          _ =&gt; <span class="hljs-literal">None</span>
                                      }
                                  })
                                  .collect();

            logger(&amp;<span class="hljs-built_in">format!</span>(<span class="hljs-string">"Messages:\n {}"</span>, messages.join(<span class="hljs-string">"\n"</span>)));

            <span class="hljs-keyword">if</span> output.status.success() {
                <span class="hljs-keyword">match</span> (errors, warnings) {
                    (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>) =&gt; <span class="hljs-literal">Ok</span>(ClippyResult{state: ClippyState::EndedFine,
                                        warnings: <span class="hljs-number">0</span>,
                                        errors: <span class="hljs-number">0</span>}),
                    (<span class="hljs-number">0</span>, x) =&gt; <span class="hljs-literal">Ok</span>(ClippyResult{state: ClippyState::EndedWithWarnings,
                                        warnings: x,
                                        errors: <span class="hljs-number">0</span>}),
                    _ =&gt; <span class="hljs-literal">Ok</span>(ClippyResult{state: ClippyState::EndedWithWarnings,
                                        warnings: warnings,
                                        errors: errors})
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-literal">Err</span>(<span class="hljs-built_in">format!</span>(<span class="hljs-string">"Clippy failed with Error code: {}"</span>, output.status.code().unwrap_or(-<span class="hljs-number">999</span>)))
            }
        },
        <span class="hljs-literal">Err</span>(error) =&gt; <span class="hljs-literal">Err</span>(<span class="hljs-built_in">format!</span>(<span class="hljs-string">"Running Clippy failed: {}"</span>, error))
    }
}

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">update_for_github</span></span>&lt;F&gt;(user: &amp;<span class="hljs-keyword">str</span>, repo: &amp;<span class="hljs-keyword">str</span>, sha: &amp;<span class="hljs-keyword">str</span>, logger: F) -&gt; <span class="hljs-built_in">Result</span>&lt;ClippyResult, <span class="hljs-built_in">String</span>&gt;
    <span class="hljs-keyword">where</span> F : <span class="hljs-built_in">Fn</span>(&amp;<span class="hljs-keyword">str</span>) {
    logger(<span class="hljs-string">"Creating Temp Directory..."</span>);

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-literal">Ok</span>(temp_dir) = TempDir::new(&amp;<span class="hljs-built_in">format!</span>(<span class="hljs-string">"github_{0}_{1}_{2}"</span>,
                                                user,
                                                repo,
                                                sha)) {

        <span class="hljs-keyword">let</span> github_url = <span class="hljs-built_in">format!</span>(<span class="hljs-string">"https://codeload.github.com/{0}/{1}/zip/{2}"</span>,
                                 user,
                                 repo,
                                 sha);


        logger(&amp;<span class="hljs-built_in">format!</span>(<span class="hljs-string">"Fetching {}"</span>, &amp;github_url));
        <span class="hljs-keyword">match</span> download_and_unzip(&amp;github_url, &amp;temp_dir) {
            <span class="hljs-literal">Ok</span>(files) =&gt; {
                logger(&amp;<span class="hljs-built_in">format!</span>(<span class="hljs-string">"Extracted: \n - {}"</span>, files.join(<span class="hljs-string">"\n - "</span>)));
                <span class="hljs-keyword">match</span> files.iter().find(|item| item.to_lowercase().ends_with(<span class="hljs-string">"cargo.toml"</span>)) {
                    <span class="hljs-literal">Some</span>(file) =&gt; {
                        <span class="hljs-keyword">let</span> path = Path::new(file);
                        <span class="hljs-keyword">let</span> parent_directory = path.parent().unwrap();
                        logger(&amp;<span class="hljs-built_in">format!</span>(<span class="hljs-string">"Cargo file found in {}"</span>, parent_directory .to_string_lossy().into_owned()));
                        logger(<span class="hljs-string">"-------------------------------- Running Clippy"</span>);
                        run_clippy(parent_directory, logger)
                    }
                    _ =&gt; <span class="hljs-literal">Err</span>(<span class="hljs-built_in">String</span>::from(<span class="hljs-string">"No `Cargo.toml` file found in archive."</span>))
                }
            },
            <span class="hljs-literal">Err</span>(err) =&gt; <span class="hljs-literal">Err</span>(err)
        }
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-literal">Err</span>(<span class="hljs-built_in">String</span>::from(<span class="hljs-string">"Creating temp directory failed"</span>))
    }
}

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">trigger_update</span></span>(user: &amp;<span class="hljs-keyword">str</span>, repo: &amp;<span class="hljs-keyword">str</span>, sha: &amp;<span class="hljs-keyword">str</span>){

    <span class="hljs-keyword">let</span> user = user.to_owned();
    <span class="hljs-keyword">let</span> repo = repo.to_owned();
    <span class="hljs-keyword">let</span> sha = sha.to_owned();
    <span class="hljs-keyword">let</span> base_key = <span class="hljs-built_in">format!</span>(<span class="hljs-string">"github/{0}/{1}:{2}"</span>,
                            user,
                            repo,
                            sha).to_owned();

    <span class="hljs-keyword">let</span> result_key = <span class="hljs-built_in">format!</span>(<span class="hljs-string">"result/{}"</span>, base_key).to_owned();
    <span class="hljs-keyword">let</span> log_key = <span class="hljs-built_in">format!</span>(<span class="hljs-string">"log/{}"</span>, base_key).to_owned();
    <span class="hljs-keyword">let</span> badge_key = <span class="hljs-built_in">format!</span>(<span class="hljs-string">"badge/{}"</span>, base_key).to_owned();

    thread::spawn(move || {
        <span class="hljs-keyword">let</span> redis: redis::Connection = setup_redis();
        <span class="hljs-keyword">let</span> logger = |statement: &amp;<span class="hljs-keyword">str</span>| log_redis(&amp;redis, &amp;log_key, statement);

        <span class="hljs-comment">// let's make sure we are the first to run here,</span>
        <span class="hljs-comment">// otherwise, exit the thread preemptively</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-literal">Ok</span>(existing) = redis::transaction(&amp;redis, &amp;[log_key.clone(), badge_key.clone()], |pipe| {
            <span class="hljs-keyword">match</span> redis.exists(badge_key.clone()) {
                <span class="hljs-literal">Ok</span>(<span class="hljs-literal">Some</span>(<span class="hljs-literal">false</span>)) =&gt; {
                    pipe.cmd(<span class="hljs-string">"RPUSH"</span>)
                            .arg(log_key.clone())
                            .arg(<span class="hljs-built_in">format!</span>(<span class="hljs-string">"{0} started processing github/{1}/{2}:{3}"</span>,
                                                now_utc().rfc3339(),
                                                user,
                                                repo,
                                                sha))
                            .ignore()
                        .cmd(<span class="hljs-string">"SET"</span>)
                            .arg(badge_key.clone())
                            .arg(LINTING_BADGE_URL)
                            .ignore()
                        .cmd(<span class="hljs-string">"EXPIRE"</span>)
                            .arg(badge_key.clone())
                            .arg(<span class="hljs-number">300</span>)
                            .ignore()
                        .execute(&amp;redis);
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">Ok</span>(<span class="hljs-literal">Some</span>(<span class="hljs-literal">false</span>));
                    },
                _ =&gt; <span class="hljs-literal">Ok</span>(<span class="hljs-literal">Some</span>(<span class="hljs-literal">true</span>))
            }}) {
            <span class="hljs-keyword">if</span> existing {
                <span class="hljs-comment">// we have been alerted, the key already existed</span>
                <span class="hljs-comment">// so someone else is writing a log file. We should stop now.</span>
                <span class="hljs-keyword">return</span>;
            }
        }


        <span class="hljs-keyword">let</span> (text, color) : (<span class="hljs-built_in">String</span>, &amp;<span class="hljs-keyword">str</span>) = <span class="hljs-keyword">match</span> update_for_github(&amp;user, &amp;repo, &amp;sha, logger) {
            <span class="hljs-literal">Ok</span>(result) =&gt; {
                <span class="hljs-keyword">match</span> result.state {
                    ClippyState::Running =&gt; (<span class="hljs-built_in">String</span>::from(<span class="hljs-string">"linting"</span>), <span class="hljs-string">"blue"</span>),
                    ClippyState::EndedFine =&gt; (<span class="hljs-built_in">String</span>::from(<span class="hljs-string">"success"</span>), <span class="hljs-string">"brightgreen"</span>),
                    ClippyState::EndedWithWarnings =&gt; (
                            <span class="hljs-built_in">format!</span>(<span class="hljs-string">"{0} warnings"</span>, result.warnings),
                            <span class="hljs-keyword">match</span> result.warnings {
                                <span class="hljs-number">1</span>...<span class="hljs-number">5</span> =&gt; <span class="hljs-string">"yellowgreen"</span>,
                                <span class="hljs-number">5</span>...<span class="hljs-number">10</span> =&gt; <span class="hljs-string">"yellow"</span>,
                                <span class="hljs-number">10</span>...<span class="hljs-number">50</span> =&gt; <span class="hljs-string">"orange"</span>,
                                _ =&gt; <span class="hljs-string">"red"</span>
                            }),
                    ClippyState::EndedWithErrors =&gt; (
                            <span class="hljs-built_in">format!</span>(<span class="hljs-string">"{0} errors"</span>, result.errors),
                            <span class="hljs-string">"red"</span>)
                }
            },
            <span class="hljs-literal">Err</span>(error) =&gt; {
                log_redis(&amp;redis, &amp;log_key, &amp;<span class="hljs-built_in">format!</span>(<span class="hljs-string">"Failed: {}"</span>, error));
                (<span class="hljs-built_in">String</span>::from(<span class="hljs-string">"failed"</span>), <span class="hljs-string">"red"</span>)
            }
        };

        log_redis(&amp;redis, &amp;log_key, &amp;<span class="hljs-built_in">format!</span>(<span class="hljs-string">"------------------------------------------\n Clippy's final verdict: {}"</span>, text));
        redis::pipe()
            .cmd(<span class="hljs-string">"SET"</span>)
                .arg(result_key)
                .arg(text.clone())
                .ignore()
            .cmd(<span class="hljs-string">"SET"</span>)
                .arg(badge_key)
                .arg(<span class="hljs-built_in">format!</span>(<span class="hljs-string">"https://img.shields.io/badge/clippy-{}-{}"</span>, text, color))
                .ignore()
            .execute(&amp;redis);
    });

}

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() {
    <span class="hljs-comment">// setup logger</span>
    env_logger::init().unwrap();

    <span class="hljs-keyword">let</span> router = router!(
        get <span class="hljs-string">"/github/sha/:user/:repo/:sha/:method"</span> =&gt; github_handler,
        get <span class="hljs-string">"/github/:user/:repo/:branch/:method"</span> =&gt; github_finder,
        get <span class="hljs-string">"/github/:user/:repo/:method"</span> =&gt; github_finder,
        get <span class="hljs-string">"/"</span> =&gt; Static::new(Path::new(<span class="hljs-string">"static"</span>))
    );

    warn!(<span class="hljs-string">"Server running at 8080"</span>);
    Iron::new(router).http(<span class="hljs-string">"0.0.0.0:8080"</span>).unwrap();

    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">github_finder</span></span>(req: &amp;<span class="hljs-keyword">mut</span> Request) -&gt; IronResult&lt;Response&gt; {

        <span class="hljs-comment">// expand a branch name into the hash, keep the redirect for 5min</span>

        <span class="hljs-keyword">let</span> <span class="hljs-keyword">ref</span> router = req.extensions.get::&lt;Router&gt;().unwrap();
        <span class="hljs-keyword">let</span> redis: redis::Connection = setup_redis();
        <span class="hljs-keyword">let</span> hyper_client: Client = Client::new();

        <span class="hljs-keyword">let</span> user = router.find(<span class="hljs-string">"user"</span>).unwrap();
        <span class="hljs-keyword">let</span> repo = router.find(<span class="hljs-string">"repo"</span>).unwrap();
        <span class="hljs-keyword">let</span> branch = router.find(<span class="hljs-string">"branch"</span>).unwrap_or(<span class="hljs-string">"master"</span>);
        <span class="hljs-keyword">let</span> method = router.find(<span class="hljs-string">"method"</span>).unwrap_or(<span class="hljs-string">"badge.svg"</span>);

        <span class="hljs-keyword">let</span> redis_key = <span class="hljs-built_in">format!</span>(<span class="hljs-string">"cached-sha/github/{0}/{1}:{2}"</span>, user, repo, branch);
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> target_url = req.url.clone().into_generic_url().to_owned();

        <span class="hljs-keyword">match</span> redis.get(redis_key.to_owned()){
            <span class="hljs-comment">// we have a cached value, redirect directly</span>
            <span class="hljs-literal">Ok</span>(Value::Data(sha)) =&gt;{
                {
                    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> path = target_url.path_mut().unwrap();
                    path.clear();
                    path.extend_from_slice(&amp;[<span class="hljs-string">"github"</span>.to_owned(), <span class="hljs-string">"sha"</span>.to_owned(), user.to_owned(), repo.to_owned(), <span class="hljs-built_in">String</span>::from_utf8(sha).unwrap().to_owned(), method.to_owned()]);
                }
                <span class="hljs-keyword">return</span> redir(&amp;target_url, &amp;req.url);
            },
            _ =&gt; {
                <span class="hljs-keyword">let</span> github_url = <span class="hljs-built_in">format!</span>(<span class="hljs-string">"https://api.github.com/repos/{0}/{1}/git/refs/heads/{2}"</span>,
                                         user,
                                         repo,
                                         branch);
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-literal">Some</span>(body) = fetch(&amp;hyper_client, &amp;github_url) {
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-literal">Ok</span>(json) = Json::from_str(&amp;body) {
                        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-literal">Some</span>(&amp;Json::<span class="hljs-built_in">String</span>(<span class="hljs-keyword">ref</span> sha)) = json.find_path(&amp;[<span class="hljs-string">"object"</span>, <span class="hljs-string">"sha"</span>]) {
                            {
                                <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> path = target_url.path_mut().unwrap();
                                path.clear();
                                path.extend_from_slice(&amp;[<span class="hljs-string">"github"</span>.to_owned(), <span class="hljs-string">"sha"</span>.to_owned(), user.to_owned(), repo.to_owned(), sha.to_string().to_owned(), method.to_owned()]);
                            }
                            set_redis_cache(&amp;redis, &amp;redis_key, &amp;target_url.serialize());
                            <span class="hljs-keyword">return</span> redir(&amp;target_url, &amp;req.url);

                        } <span class="hljs-keyword">else</span> {
                            warn!(<span class="hljs-string">"{}: SHA not found in JSON: {}"</span>, &amp;github_url, &amp;json);
                            <span class="hljs-keyword">return</span> <span class="hljs-literal">Ok</span>(Response::with((status::NotFound,
                                                      <span class="hljs-built_in">format!</span>(<span class="hljs-string">"Couldn't find on Github {}"</span>, &amp;github_url))));
                        }
                    } <span class="hljs-keyword">else</span> {
                        warn!(<span class="hljs-string">"{}: Couldn't parse Githubs JSON response: {}"</span>,
                              &amp;github_url,
                              &amp;body);
                        <span class="hljs-keyword">return</span> <span class="hljs-literal">Ok</span>(Response::with((status::InternalServerError,
                                                  <span class="hljs-string">"Couldn't parse Githubs JSON response"</span>)));
                    }
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">Ok</span>(Response::with((status::NotFound,
                                              <span class="hljs-built_in">format!</span>(<span class="hljs-string">"Couldn't find on Github {}"</span>, &amp;github_url))));
                }
                <span class="hljs-literal">Ok</span>(Response::with(status::InternalServerError))

            }
        }
    }


    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">github_handler</span></span>(req: &amp;<span class="hljs-keyword">mut</span> Request) -&gt; IronResult&lt;Response&gt; {

        <span class="hljs-keyword">let</span> <span class="hljs-keyword">ref</span> router = req.extensions.get::&lt;Router&gt;().unwrap();
        <span class="hljs-keyword">let</span> redis: redis::Connection = setup_redis();

        <span class="hljs-keyword">let</span> user = router.find(<span class="hljs-string">"user"</span>).unwrap();
        <span class="hljs-keyword">let</span> repo = router.find(<span class="hljs-string">"repo"</span>).unwrap();
        <span class="hljs-keyword">let</span> sha = router.find(<span class="hljs-string">"sha"</span>).unwrap();
        <span class="hljs-keyword">let</span> filename: <span class="hljs-built_in">Vec</span>&lt;&amp;<span class="hljs-keyword">str</span>&gt; = router.find(<span class="hljs-string">"method"</span>)
                                        .unwrap_or(<span class="hljs-string">"badge.svg"</span>)
                                        .rsplitn(<span class="hljs-number">2</span>, <span class="hljs-string">'.'</span>)
                                        .collect();
        <span class="hljs-keyword">let</span> (method, ext) = <span class="hljs-keyword">match</span> filename.len() {
            <span class="hljs-number">2</span> =&gt; (filename[<span class="hljs-number">1</span>], filename[<span class="hljs-number">0</span>]),
            _ =&gt; (filename[<span class="hljs-number">0</span>], <span class="hljs-string">""</span>)
        };

        <span class="hljs-keyword">let</span> redis_key = <span class="hljs-built_in">format!</span>(<span class="hljs-string">"{0}/github/{1}/{2}:{3}"</span>, method, user, repo, sha);

        <span class="hljs-keyword">match</span> method {
            <span class="hljs-string">"badge"</span> =&gt; {
                <span class="hljs-comment">// if this is a badge, then we might have a cached version</span>
                <span class="hljs-keyword">match</span> redis.get(redis_key.to_owned()){
                    <span class="hljs-literal">Ok</span>(<span class="hljs-literal">Some</span>(Value::Data(base_url))) =&gt; {
                        <span class="hljs-keyword">let</span> base_url = <span class="hljs-built_in">String</span>::from_utf8(base_url).unwrap().to_owned();
                        <span class="hljs-keyword">let</span> target_badge = <span class="hljs-keyword">match</span> req.url.clone().query {
                            <span class="hljs-literal">Some</span>(query) =&gt; <span class="hljs-built_in">format!</span>(<span class="hljs-string">"{}.{}?{}"</span>, base_url, ext, query),
                            _ =&gt; <span class="hljs-built_in">format!</span>(<span class="hljs-string">"{}.{}"</span>, base_url, ext)
                        };
                        <span class="hljs-literal">Ok</span>(Response::with((status::TemporaryRedirect,
                                           Redirect(iUrl::parse(&amp;target_badge).unwrap()))))
                    },
                    _ =&gt; {
                        trigger_update(&amp;user, &amp;repo, &amp;sha);
                        <span class="hljs-keyword">let</span> target_badge = <span class="hljs-built_in">format!</span>(<span class="hljs-string">"{}.{}"</span>, LINTING_BADGE_URL, ext);
                        <span class="hljs-keyword">return</span> redir(&amp;Url::parse(&amp;target_badge).unwrap(), &amp;req.url);
                    }
                }
            },
            <span class="hljs-string">"log"</span> =&gt; {
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-literal">Ok</span>(<span class="hljs-literal">Some</span>(Value::Bulk(logs))) = redis.lrange(redis_key.to_owned(), <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>) {
                    <span class="hljs-keyword">let</span> logs: <span class="hljs-built_in">Vec</span>&lt;<span class="hljs-built_in">String</span>&gt; = logs.iter().map(|<span class="hljs-keyword">ref</span> v| {
                        <span class="hljs-keyword">match</span> *v {
                            &amp;Value::Data(<span class="hljs-keyword">ref</span> val) =&gt; <span class="hljs-built_in">String</span>::from_utf8(val.to_owned()).unwrap().to_owned(),
                            _ =&gt; <span class="hljs-string">""</span>.to_owned()
                        }
                    }).collect();
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">Ok</span>(Response::with((status::<span class="hljs-literal">Ok</span>, logs.join(<span class="hljs-string">"\n"</span>))));
                } <span class="hljs-keyword">else</span> {
                    trigger_update(&amp;user, &amp;repo, &amp;sha);
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">Ok</span>(Response::with((status::Created,
                                   <span class="hljs-string">"Build scheduled. Please refresh to see logs."</span>)));
                }
            }
            <span class="hljs-string">"status"</span> =&gt; {
                <span class="hljs-keyword">let</span> redis_key = <span class="hljs-built_in">format!</span>(<span class="hljs-string">"result/github/{0}/{1}:{2}"</span>,
                                        user,
                                        repo,
                                        sha).to_owned();

                <span class="hljs-keyword">match</span> redis.get(redis_key.to_owned()) {
                    <span class="hljs-literal">Ok</span>(<span class="hljs-literal">Some</span>(Value::Data(status))) =&gt; <span class="hljs-literal">Ok</span>(Response::with((status::<span class="hljs-literal">Ok</span>,
                                                                        <span class="hljs-built_in">String</span>::from_utf8(status).unwrap().to_owned()))),
                    _ =&gt; {
                        trigger_update(&amp;user, &amp;repo, &amp;sha);
                        <span class="hljs-literal">Ok</span>(Response::with((status::Created,<span class="hljs-string">"running"</span>)))
                    }
                }
            }
            _ =&gt; {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">Ok</span>(Response::with((status::BadRequest,
                                   <span class="hljs-built_in">format!</span>(<span class="hljs-string">"Not Yet Implemented: {}"</span>, method))));
            }
        }
    }
}

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">log_redis</span></span>(redis: &amp;redis::Connection, key: &amp;<span class="hljs-keyword">str</span>, value: &amp;<span class="hljs-keyword">str</span>) {
    redis::pipe()
        .cmd(<span class="hljs-string">"RPUSH"</span>)
            .arg(key.clone())
            .arg(<span class="hljs-built_in">format!</span>(<span class="hljs-string">"{0} {1}"</span>,
                         now_utc().rfc3339(),
                         value))
            .ignore()
        .execute(redis);
}

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">set_redis_cache</span></span>(redis: &amp;redis::Connection, key: &amp;<span class="hljs-keyword">str</span>, value: &amp;<span class="hljs-keyword">str</span>) {
    redis::pipe()
        .cmd(<span class="hljs-string">"SET"</span>).arg(key.clone()).arg(value).ignore()
        .cmd(<span class="hljs-string">"EXPIRE"</span>).arg(key.clone()).arg(<span class="hljs-number">5</span> * <span class="hljs-number">60</span>).ignore() <span class="hljs-comment">// we expire in 5min</span>
        .execute(redis);
}

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">redir</span></span>(url: &amp;Url, source_url: &amp;iUrl) -&gt; IronResult&lt;Response&gt; {
    <span class="hljs-keyword">match</span> iUrl::from_generic_url(url.clone()) {
        <span class="hljs-literal">Ok</span>(<span class="hljs-keyword">mut</span> redir_url) =&gt; {
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-literal">Some</span>(<span class="hljs-keyword">ref</span> query) = source_url.query {
                redir_url.query = <span class="hljs-literal">Some</span>(query.clone());
            }
            <span class="hljs-literal">Ok</span>(Response::with((status::TemporaryRedirect, Redirect(redir_url))))
        }
        <span class="hljs-literal">Err</span>(err) =&gt; <span class="hljs-literal">Ok</span>(Response::with((status::InternalServerError, err))),
    }
}

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">fetch</span></span>(client: &amp;Client, url: &amp;<span class="hljs-keyword">str</span>) -&gt; <span class="hljs-built_in">Option</span>&lt;<span class="hljs-built_in">String</span>&gt; {
    <span class="hljs-keyword">let</span> res = client.get(url)
                    .header(header::UserAgent(<span class="hljs-string">"Clippy/0.1"</span>.to_owned()))
                    .header(header::Accept(<span class="hljs-built_in">vec!</span>[qitem(mime!(_/_))]))
                    .header(header::Connection::close());
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-literal">Ok</span>(<span class="hljs-keyword">mut</span> res) = res.send() {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> body = <span class="hljs-built_in">String</span>::new();
        <span class="hljs-keyword">if</span> res.read_to_string(&amp;<span class="hljs-keyword">mut</span> body).is_ok() {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">Some</span>(body);
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>;
}

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">setup_redis</span></span>() -&gt; redis::Connection {
    <span class="hljs-keyword">let</span> url = redis::parse_redis_url(&amp;env::var(<span class="hljs-string">"REDIS_URL"</span>)
                                          .unwrap_or(<span class="hljs-string">"redis://redis/"</span>.to_owned()))
                  .unwrap();
    redis::Client::open(url)
        .unwrap()
        .get_connection()
        .unwrap()
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
